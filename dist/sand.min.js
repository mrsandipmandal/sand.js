/* sand.min.js - tiny runtime */
(function(w){function sE(e,c){const n=Object.keys(c||{}),v=Object.values(c||{});try{return (new Function(...n,'with(this)return ('+e+');')).apply(c,v);}catch(e){return undefined}}function createReactive(o){const d=new Map(),st=[];function t(k){const f=st[st.length-1];if(!f)return;let s=d.get(k);if(!s){s=new Set();d.set(k,s)}s.add(f)}function r(k){const s=d.get(k);if(!s)return;s.forEach(fn=>fn())}const h={get(t,k){if(k==='__isProxy')return true;t(k);const R=Reflect.get(t,k);return (R&&typeof R==='object')?createReactive(R).proxy:R},set(t,k,v){const old=t[k];const ok=Reflect.set(t,k,v);if(old!==v)r(k);return ok}};const p=new Proxy(Object.assign({},o||{}),h);function e(fn){const w=function(){try{st.push(w);fn()}finally{st.pop()}};w();return w}return{proxy:p,effect:e}}function parseA(el){const out=[];for(let i=0;i<el.attributes.length;i++){const a=el.attributes[i];if(a.name.startsWith('s-')||a.name.startsWith('@')||a.name==='s-cloak')out.push({name:a.name,value:a.value})}return out}function mountEl(el,ctx,run){const attrs=parseA(el);for(const a of attrs){if(a.name==='s-cloak'){el.removeAttribute('s-cloak');continue}if(a.name==='s-data')continue;if(a.name==='s-show'){run(()=>{const v=sE(a.value,ctx);el.style.display=v?'':'none'})}else if(a.name==='s-bind'){const parts=a.value.split(',').map(s=>s.trim()).filter(Boolean);parts.forEach(p=>{const sp=p.split(':').map(x=>x.trim());if(!sp[0]||!sp[1])return;run(()=>{const v=sE(sp[1],ctx);try{el[sp[0]]=v}catch(e){el.setAttribute(sp[0],v)}})})}else if(a.name==='s-model'){const key=a.value.trim();el.value=sE(key,ctx)||'';run(()=>{const v=sE(key,ctx);if(el.value!==v)el.value=v==null?'':v});el.addEventListener('input',()=>{if(key.indexOf('.')===-1)ctx[key]=el.value})}else if(a.name==='s-for'){const m=a.value.match(/^(\s*)([\w_$]+)\s+in\s+(.+)$/);if(!m)continue;const item=m[2],listExpr=m[3];const marker=document.createComment('s-for');const tpl=el.cloneNode(true);el.parentNode.insertBefore(marker,el);el.parentNode.removeChild(el);run(()=>{const list=sE(listExpr,ctx)||[];let n=marker.nextSibling;while(n&&!n.__s_end){const rm=n;n=n.nextSibling;rm.parentNode&&rm.parentNode.removeChild(rm)};list.forEach(it=>{const node=tpl.cloneNode(true);const child=Object.create(ctx);child[item]=it;const end=document.createComment('s-for-end');end.__s_end=true;marker.parentNode.insertBefore(node,marker.nextSibling);marker.parentNode.insertBefore(end,marker.nextSibling);mountTree(node,child)})})}else if(a.name.startsWith('@')){const ev=a.name.slice(1);el.addEventListener(ev,function(e){try{sE(a.value,Object.assign({},ctx,{$event:e}))}catch(err){}})}}}function mountTree(root,ctx){const walker=document.createTreeWalker(root,NodeFilter.SHOW_ELEMENT,null,false);const nodes=[];if(root.nodeType===1)nodes.push(root);while(walker.nextNode())nodes.push(walker.currentNode);nodes.forEach(el=>{if(el.hasAttribute('s-data'))return;mountEl(el,ctx,function(fn){if(typeof ctx.__effect==='function'){ctx.__effect(fn)}else fn()})})}function mount(root){root=root||document.body;const nodes=root.querySelectorAll('[s-data]');nodes.forEach(el=>{const expr=el.getAttribute('s-data');let initial={};try{initial=sE(expr,{})||{}}catch(e){}const R=createReactive(initial);const ctx=Object.create(null);Object.keys(R.proxy).forEach(k=>ctx[k]=R.proxy[k]);ctx.__effect=function(fn){R.effect(function(){Object.keys(R.proxy).forEach(k=>ctx[k]=R.proxy[k]);fn()})};ctx.$el=el;mountTree(el,ctx);el.removeAttribute('s-data')})}if(document.readyState==='loading')window.addEventListener('DOMContentLoaded',mount);else mount();w.Sand={mount:mount,createReactive:createReactive}})(window);
